<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>Dolphin blueprints</title>
		<style>
			html {
				height: 100%;
			}

			body {
				height: 99%;
				margin: 0;
			}

			.container {
				height: 100%;
				display: flex;
			}

			#editor,
			#diagram {
				height: 100%;
			}

			#editor {
				width: 30%;
				min-width: 400px;
				border-right: 1px solid black;
			}

			#diagram {
				width: 70%;
			}

		</style>
		<script src="dist/ace.js"></script>
	</head>
	<body>
		<!-- <p>
			Element dragging will not affect 
		</p> -->
		<div class="container">
			<div id="editor"></div>
			<div id="diagram"></div>
		</div>

		<script src="dist/bundle.js"></script>
		<script>
			var editor = ace.edit("editor");
			editor.setTheme("ace/theme/github");
			editor.getSession().setMode("ace/mode/json");
			editor.$blockScrolling = Infinity;

			var store = dolphin.store;

			// diagram comes first
			syncModels("diagram -> editor");


			// create data flow
			editor.on("change", function (e) {
				syncModels("editor -> diagram");
			});

			store.subscribe(function () {
				syncModels("diagram -> editor");
			});


			function syncModels(strategy) {
				var diagramModel = JSON.stringify(store.getState(), null, "\t");
				var editorModel = editor.getValue();

				if (diagramModel !== editorModel) {
					switch (strategy) {
						case "diagram -> editor":
							editor.setValue(diagramModel);
							break;

						case "editor -> diagram":
							try {
								store.setState(JSON.parse(editorModel));
							} catch (e) {}
							break;

						default:
							throw new Error("Unknown model syncing strategy");
					}
				}
			}
		</script>
	</body>
</html>
